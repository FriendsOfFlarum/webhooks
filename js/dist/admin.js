(()=>{var t={n:e=>{var o=e&&e.__esModule?()=>e.default:()=>e;return t.d(o,{a:o}),o},d:(e,o)=>{for(var s in o)t.o(o,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:o[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e),t.d(e,{extend:()=>K});const o=flarum.reg.get("core","admin/app");var s=t.n(o);const n=flarum.reg.get("core","common/extenders");var a=t.n(n);function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function r(t,e,o){return(e=function(t){var e=function(t){if("object"!=i(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var o=e.call(t,"string");if("object"!=i(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==i(e)?e:e+""}(e))in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}const l=flarum.reg.get("core","admin/components/ExtensionPage");var h=t.n(l);const d=flarum.reg.get("core","common/utils/Stream");var c=t.n(d);const u=flarum.reg.get("core","common/utils/withAttr");var b=t.n(u);const g=flarum.reg.get("core","common/components/Button");var f=t.n(g);const p=flarum.reg.get("core","common/components/Select");var v=t.n(p);const k=flarum.reg.get("core","common/components/LoadingIndicator");var w=t.n(k);const x=flarum.reg.get("core","common/Component");var y=t.n(x);const T=flarum.reg.get("core","common/components/Alert");var _=t.n(T);const N=flarum.reg.get("core","common/components/Tooltip");var W=t.n(N);const P=flarum.reg.get("flarum-tags","common/helpers/tagsLabel");var C=t.n(P);const S=flarum.reg.get("core","common/components/Switch");var I=t.n(S);const B=flarum.reg.get("core","common/components/Dropdown");var E=t.n(B);const L=flarum.reg.get("core","common/components/Icon");var F=t.n(L);const j=flarum.reg.get("core","common/models/Group");var D=t.n(j);const M=flarum.reg.get("core","common/components/FormModal");var O=t.n(M);const z=flarum.reg.get("core","common/components/Form");var A=t.n(z);const U={2:"fas fa-globe",3:"fas fa-user"};class V extends(O()){constructor(){super(...arguments),r(this,"loadingEvents",!1),r(this,"webhook",void 0),r(this,"groupId",void 0),r(this,"extraText",void 0),r(this,"name",void 0),r(this,"usePlainText",void 0),r(this,"maxPostContentLength",void 0),r(this,"includeTags",void 0),r(this,"events",void 0)}oninit(t){super.oninit(t),this.webhook=this.attrs.webhook;const e=s().data["fof-webhooks.events"];this.groupId=c()(this.webhook.groupId()||D().GUEST_ID),this.extraText=c()(this.webhook.extraText()||""),this.name=c()(this.webhook.name()||""),this.usePlainText=c()(this.webhook.usePlainText()),this.maxPostContentLength=c()(this.webhook.maxPostContentLength()),this.includeTags=c()(this.webhook.includeTags()),this.events=((t,e)=>{const o=Object.keys(t),s=Object.values(t);return o.map(e).reduce((t,e,n)=>(t[e]||(t[e]={}),t[e][o[n]]=s[n],t),{})})(e.reduce((t,e)=>{var o;const s=/((?:[a-z]\\?)+?)\\Events?\\([a-z]+)/i.exec(e),n={full:e,name:null!=(o=null==s?void 0:s[2])?o:e};if(!s)return t.other.push(n),t.other=t.other.sort(),t;const a=s[1].toLowerCase().replaceAll("\\",".");return t[a]||(t[a]=[]),t[a]=t[a].concat(n).sort(),t},{other:[]}),t=>t.split(".")[0])}className(){return"Modal--medium"}title(){return s().translator.trans("fof-webhooks.admin.settings.modal.title")}content(){var t;const e=s().store.getById("groups",this.groupId()),o=!(null==(t=this.webhook.tags())||!t.length);return m("div",{className:"FofWebhooksModal Modal-body"},m(A(),null,m(I(),{state:this.usePlainText(),onchange:this.usePlainText},s().translator.trans("fof-webhooks.admin.settings.modal.use_plain_text_label")),m("div",{className:"Form-group"},m("label",{className:"label"},s().translator.trans("fof-webhooks.admin.settings.modal.max_post_content_length_label")),m("p",{className:"helpText"},s().translator.trans("fof-webhooks.admin.settings.modal.max_post_content_length_help")),m("input",{type:"number",min:"0",className:"FormControl",bidi:this.maxPostContentLength,onkeypress:this.onkeypress.bind(this)})),m("div",{className:"Form-group hasLoading"},m("label",{className:"label"},s().translator.trans("fof-webhooks.admin.settings.modal.extra_text_label")),m("p",{className:"helpText"},s().translator.trans("fof-webhooks.admin.settings.modal.extra_text_help")),m("input",{type:"text",className:"FormControl",bidi:this.extraText,onkeypress:this.onkeypress.bind(this)})),m("div",{className:"Form-group"},m("label",{className:"label"},s().translator.trans("fof-webhooks.admin.settings.modal.name_label")),m("p",{className:"helpText"},s().translator.trans("fof-webhooks.admin.settings.modal.name_help")),m("input",{type:"text",className:"FormControl",bidi:this.name,placeholder:s().forum.attribute("title"),onkeypress:this.onkeypress.bind(this)})),m("div",{className:"Form-group"},m("label",{className:"label"},s().translator.trans("fof-webhooks.admin.settings.modal.group_label")),m("p",{className:"helpText"},s().translator.trans("fof-webhooks.admin.settings.modal.group_help")),m(E(),{label:[m(F(),{name:e.icon()||U[e.id()]}),e.namePlural()],buttonClassName:"Button Button--danger"},s().store.all("groups").filter(t=>["1","2"].includes(t.id())).map(t=>m(f(),{active:e.id()===t.id(),disabled:e.id()===t.id(),icon:t.icon()||U[t.id()],onclick:()=>this.groupId(t.id()),type:"button"},t.namePlural())))),m("div",{className:"Form-group Webhook-events"},m("label",{className:"label"},s().translator.trans("fof-webhooks.admin.settings.modal.events_label")),m("p",{className:"helpText"},s().translator.trans("fof-webhooks.admin.settings.modal.description")),"microsoft-teams"!==this.webhook.service()&&m("div",{style:{marginTop:"15px"}},m(I(),{state:this.includeTags(),onchange:this.includeTags,disabled:!o},s().translator.trans("fof-webhooks.admin.settings.modal.include_matching_tags_label"))),Object.entries(this.events).map(t=>{let[,e]=t;return m("div",null,Object.entries(e).sort((t,e)=>{const o=String(t[0]).toUpperCase(),s=String(e[0]).toUpperCase();return o<s?-1:o>s?1:0}).map(t=>{let[e,o]=t;return o.length?m("div",null,m("h3",null,this.translate(e)),o.map(t=>m(I(),{state:this.webhook.events().includes(t.full),disabled:!!this.loadingEvents,loading:this.loadingEvents===t.full,onchange:this.updateEvents.bind(this,t.full)},this.translate(e,t.name.toLowerCase())))):null}))})),m("div",{className:"Form-group"},m(f(),{type:"submit",className:"Button Button--primary",loading:this.loading,disabled:!this.isDirty()},s().translator.trans("core.admin.settings.submit_button")))))}translate(t,e){return void 0===e&&(e="title"),s().translator.trans("fof-webhooks.admin.settings.actions.".concat(t,".").concat(e))}isDirty(){return this.extraText()!=this.webhook.extraText()||this.groupId()!==this.webhook.groupId()||this.usePlainText()!==this.webhook.usePlainText()||this.includeTags()!==this.webhook.includeTags()||this.maxPostContentLength()!=this.webhook.maxPostContentLength()||this.name()!=this.webhook.name()}async onsubmit(t){t.preventDefault(),this.loading=!0;try{await this.webhook.save({extraText:this.extraText(),groupId:this.groupId(),usePlainText:this.usePlainText(),includeTags:this.includeTags(),maxPostContentLength:this.maxPostContentLength()||0,name:this.name()})}finally{this.loading=!1,m.redraw()}}onkeypress(t){"Enter"===t.key&&this.onsubmit(t)}updateEvents(t,e){this.loadingEvents=t;let o=[...this.webhook.events()];return e?o.push(t):o.splice(o.indexOf(t),1),this.attrs.updateWebhook(o).finally(()=>{this.loadingEvents=!1,m.redraw()})}}flarum.reg.add("fof-webhooks","admin/components/WebhookEditModal",V);class G extends(y()){constructor(){super(...arguments),r(this,"webhook",void 0),r(this,"services",void 0),r(this,"url",void 0),r(this,"service",void 0),r(this,"events",void 0),r(this,"error",void 0),r(this,"loading",void 0),r(this,"deleting",!1)}oninit(t){super.oninit(t),this.webhook=this.attrs.webhook,this.services=this.attrs.services,this.url=c()(this.webhook.url()),this.service=c()(this.webhook.service()),this.events=c()(this.webhook.events()),this.error=c()(this.webhook.error()),this.loading={}}view(){var t;const{webhook:e,services:o}=this,n=s().initializers.has("flarum-tags"),a=e.tags().filter(Boolean),i=e.service(),r=[e.error&&e.error()];o[i]?e.isValid()?n||0===e.tags().length?a.length!==(null==(t=e.tags())?void 0:t.length)&&r.push(s().translator.trans("fof-webhooks.admin.errors.tag_invalid")):r.push(s().translator.trans("fof-webhooks.admin.errors.tag_disabled")):r.push(s().translator.trans("fof-webhooks.admin.errors.url_invalid")):r.push(s().translator.trans("fof-webhooks.admin.errors.service_not_found",{service:i}));const l=()=>s().modal.show(()=>flarum.reg.asyncModuleImport("ext:flarum/tags/common/components/TagSelectionModal"),{selectedTags:a,onsubmit:t=>this.update("tagIds")(t.map(t=>t.id()))});return m("div",{className:"Webhooks--row","data-webhook-id":e.id()},m("div",{className:"Webhook-input"},m(v(),{options:o,value:i,onchange:this.update("service"),disabled:this.loading.service}),m("input",{className:"FormControl Webhook-url",type:"url",value:this.url(),onchange:b()("value",this.update("url")),disabled:this.loading.url,placeholder:s().translator.trans("fof-webhooks.admin.settings.help.url")}),n&&m(W(),{text:s().translator.trans("fof-webhooks.admin.settings.item.edit_tags_button")},m(f(),{className:"Button",onclick:l},a.length?C()(a,{onclick:l}):m("span",{className:"TagsLabel",onclick:l},s().translator.trans("fof-webhooks.admin.settings.item.tag_any_label")))),m(W(),{text:s().translator.trans("fof-webhooks.admin.settings.item.edit_tooltip")},m(f(),{type:"button",className:"Button Button--icon Webhook-button",icon:"fas fa-edit",onclick:()=>s().modal.show(V,{webhook:e,updateWebhook:this.update("events")})})),m(W(),{text:s().translator.trans("fof-webhooks.admin.settings.item.delete_tooltip")},m(f(),{type:"button",className:"Button Button--danger Button--icon Webhook-button",icon:"fas fa-times",loading:this.deleting,onclick:this.delete.bind(this)})),m("span",null)),!this.events().length&&m(_(),{className:"Webhook-error",dismissible:!1},s().translator.trans("fof-webhooks.admin.settings.help.disabled")),r.filter(Boolean).map(t=>m(_(),{className:"Webhook-error",type:"error",dismissible:!1},"string"==typeof t?s().translator.trans(t):t)))}update(t){return async e=>{this.loading[t]=!0;try{await this.webhook.save({[t]:e})}finally{this.loading[t]=!1,t in this&&this[t](e),m.redraw()}}}async delete(){var t;this.deleting=!0;const e=null!=(t=this.services[this.webhook.service()])?t:this.webhook.service(),o=s().translator.trans("fof-webhooks.admin.settings.item.delete_confirm_alert",{service:e},!0);try{if(confirm(o))return await this.webhook.delete()}finally{this.deleting=!1,m.redraw()}}}flarum.reg.add("fof-webhooks","admin/components/SettingsListItem",G);class R extends(h()){constructor(){super(...arguments),r(this,"services",void 0),r(this,"values",void 0),r(this,"newWebhook",void 0),r(this,"loadingData",void 0)}oninit(t){super.oninit(t);const e=s().data["fof-webhooks.services"];this.values={},this.services=e.reduce((t,e)=>(t[e]=s().translator.trans("fof-webhooks.admin.settings.services.".concat(e),{},!0),t),{}),this.newWebhook={service:c()("discord"),url:c()(""),loading:c()(!1)},this.loadingData=c()(!0)}oncreate(t){super.oncreate(t),Promise.all([s().store.find("fof-webhooks"),this.isTagsEnabled()&&s().store.find("tags")]).then(()=>{this.loadingData(!1),m.redraw()})}content(){const t=s().store.all("fof-webhooks");return this.loadingData()?m(w(),null):m("div",{className:"WebhookContent"},m("div",{className:"container"},m("div",{className:"Form-group"},this.buildSettingComponent({type:"boolean",setting:"fof-webhooks.debug",label:s().translator.trans("fof-webhooks.admin.settings.debug_label"),help:s().translator.trans("fof-webhooks.admin.settings.debug_help"),loading:this.loading,onchange:this.updateDebug.bind(this)})),m("hr",null),m("form",null,m("p",{className:"helpText"},s().translator.trans("fof-webhooks.admin.settings.help.general")),this.isTagsEnabled()&&m("p",{className:"helpText"},s().translator.trans("fof-webhooks.admin.settings.help.tags")),m("fieldset",null,m("div",{className:"Webhooks--Container"},t.map(t=>m(G,{webhook:t,services:this.services})),m("div",{className:"Webhooks--row"},m("div",{className:"Webhook-input"},m(v(),{options:this.services,value:this.newWebhook.service(),onchange:this.newWebhook.service}),m("input",{className:"FormControl Webhook-url",type:"url",placeholder:s().translator.trans("fof-webhooks.admin.settings.help.url"),onchange:b()("value",this.newWebhook.url),onkeypress:this.onkeypress.bind(this)}),m(f(),{type:"button",loading:this.newWebhook.loading(),className:"Button Button--success Webhook-button",icon:"fas fa-plus",onclick:this.addWebhook.bind(this)},s().translator.trans("fof-webhooks.admin.settings.item.create_button")))))))))}addWebhook(){if(!this.newWebhook.loading())return this.newWebhook.loading(!0),s().store.createRecord("fof-webhooks").save({service:this.newWebhook.service(),url:this.newWebhook.url()}).then(()=>{this.newWebhook.service("discord"),this.newWebhook.url(""),this.newWebhook.loading(!1),m.redraw()}).catch(()=>{this.newWebhook.loading(!1),m.redraw()})}onkeypress(t){"Enter"===t.key&&this.addWebhook()}isTagsEnabled(){return!!flarum.extensions["flarum-tags"]}updateDebug(t){return this.setting("fof-webhooks.debug")(t),this.saveSettings(new Event(""))}}flarum.reg.add("fof-webhooks","admin/components/WebhooksPage",R);const q=flarum.reg.get("core","common/Model");var H=t.n(q);class J extends(H()){constructor(){super(...arguments),r(this,"service",H().attribute("service")),r(this,"url",H().attribute("url")),r(this,"error",H().attribute("error")),r(this,"events",H().attribute("events")),r(this,"tagIds",H().attribute("tagId")),r(this,"groupId",H().attribute("groupId")),r(this,"extraText",H().attribute("extraText")),r(this,"name",H().attribute("name")),r(this,"isValid",H().attribute("isValid",Boolean)),r(this,"usePlainText",H().attribute("usePlainText",Boolean)),r(this,"maxPostContentLength",H().attribute("maxPostContentLength")),r(this,"includeTags",H().attribute("includeTags",Boolean))}tags(){return this.tagIds().map(t=>s().store.getById("tags",t))}}flarum.reg.add("fof-webhooks","admin/models/Webhook",J);const K=[(new(a().Store)).add("fof-webhooks",J),(new(a().Admin)).page(R)];s().initializers.add("fof/webhooks",()=>{})})(),module.exports=e})();
//# sourceMappingURL=admin.js.map